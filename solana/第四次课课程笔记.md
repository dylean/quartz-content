---
title: 第四次课课程笔记
slug: solana_forth_class
published: 2026-01-16
description: 第四次课笔记
tags:
  - Solana
category: Web3
draft: false
---

> [!TIP]
> **课程概览**
>
> * **时间**: 2026年1月15日
> * **第一部分**: 互联网资本市场与 Solana 愿景 (主讲: Yao Yao - Solana Foundation)
> * **第二部分**: Solana 合约开发实战 - 代币程序 (主讲: 万彪)

---

## 第一部分：互联网资本市场与 Solana (Yao Yao)

### 1. 背景与愿景：互联网资本市场

* **传统金融体系的局限**：
  * 现有金融体系运作模式已有百余年历史，基于传统、原始的运营模式。
  * 跨国转账、贸易结算效率低，无法满足现代全球化的高速需求。
* **互联网资本市场 (Internet Capital Market)**：
  * **定义**：基于互联网时代技术（区块链）创建的、更加高效、普惠、全球化的新型资本市场。
  * **AI 与 Crypto 的结合**：
    * 未来趋势是 AI Agents 协助人类管理资产和生活。
    * AI 是互联网时代的产物，理解机器语言；区块链提供了一套机器可理解的价值传输协议。
    * **愿景**：未来 Agents 之间作为链上独立节点，通过区块链协议直接完成转账结算 (X 402协议等)。
  * **Solana 的角色**：不仅仅是“币圈”公链，而是致力于成为**颠覆传统金融底层的互联网资本市场基础设施**。

### 2. 为什么是 Solana? (Layer 1 竞争力)

* **Layer 1 vs Layer 2**：
  * 互联网资本市场需要**全球高度统一的流动性**。
  * **Layer 1 (Solana)**：所有流动性集中在同一个网络上，适合构建统一市场。
  * **Layer 2 (Ethereum)**：流动性分散在不同网络，跨链流转需要桥接，资金效率和互通性受限。
* **Solana 的优势**：
  * **高性能与抗压能力**：经过大规模商业场景验证（如特朗普发币时的极高并发），网络无宕机。
  * **市场地位**：高性能公链龙头，活跃用户全球最多，市值排名靠前。
  * **真实价值**：关注真实用户和真实应用收入，而非单纯的融资故事。Solana 应用收入在公链中断层领先。

### 3. 三大核心支柱与应用

互联网资本市场的三大核心用途：**交易 (Trading)**、**支付结算 (Payments)**、**融资 (Fundraising)**。

#### 3.1 稳定币与全球支付 (Payments)

* **痛点**：传统跨境贸易需线下填表、周期长（T+1/T+2）、费用高、资金门槛高、且资金托管在银行（Not your key, not your money）。
* **Solana 价值主张**：
  * **高效低成本**：底层性能支持高频、低成本转账。
  * **无许可组合**：资金掌握在用户手中。
  * **透明可审计**：所有交易链上可查。
* **案例**：
  * **PayPal (PYUSD)**：在 Solana 上发行，利用 `Token Extensions` 实现合规功能（如冻结、白名单）。流通量极高。
  * **Visa/Stripe**：大型机构开始集成 Solana 进行结算。
  * **日常支付**：主讲人分享了用 Solana (Phantom钱包) 几秒钟内完成给美国服务商汇款的案例。
* **合规性 (Token Extensions)**：Solana 原生支持复杂的合规需求（KYC、黑名单冻结等），适合银行和大型机构发行稳定币。

#### 3.2 资产代币化与 RWA (Trading & Assets)

提出了**资产图谱**的概念：

1. **有价格无价值**：如 MEME Coins (狗狗币)，虽然不知为何值钱，但有高流动性和共识。
2. **有价值无价格**：如非标资产（房地产债权、Pokemon卡牌）。
    * **案例**：Pokemon 卡牌开盲盒项目。用户10刀抽盲盒，可能抽到500刀卡牌，这是线下 RWA 的链上映射。
3. **既有价值又有价格**：理想资产，如美股、国债。

* **RWA (现实世界资产) 爆发**：Solana 链上 RWA 总值超 10 亿美金。
  * **公募基金/国债**：**BlackRock**, **Franklin Templeton (Benji 应用)**, **Ondo**, **Apollo** 均在 Solana 上发行产品。
  * **优势**：降低投资门槛（无需 VIP 资格），全天候交易。
* **美股代币化**：
  * **Xstock** (Kraken + Backed Finance)：允许在链上直接交易美股（NVDA, TSLA等）。
  * **普惠价值**：让没有美股券商账户的用户（如欠发达地区用户）也能投资优质全球资产。
  * **DeFi 结合**：股票代币可以放入 DeFi 协议（如 Byrio）提供流动性赚取收益，实现“股息+DeFi收益”的双重叠加。

#### 3.3 链上融资 (Fundraising)

* **IPO 的新形式**：
  * **Bullish**：去年8月在美股 IPO，同时接受链上稳定币（11.5亿美金）融资。
  * **Pump.fun 模式**：无需投行、券商，直接面向全球用户募资。
* **Buildpad 案例**：
  * 类似于链上的“打新”平台。
  * 帮助科技公司/项目方进行代币分销和公募，通常能募集到目标额度的3-5倍。
  * **未来趋势**：股权与代币界限模糊，科技公司可能直接通过链上发行权益进行融资，不再依赖纳斯达克等传统路径。

---

## 第二部分：Solana 合约开发实战 - 代币程序 (万彪)

### 1. 课程回顾与安全漏洞修复

* **背景**：上节课演示了“链上数据存储器”。
* **严重漏洞**：
  * 旧代码在更新 PDA (Program Derived Address) 数据时，只计算了 PDA 地址，但**没有校验**传入的账户地址是否等于计算出的 PDA 地址。
  * **后果**：攻击者可以传入任意账户作为 `pda_account`，从而修改别人的数据。
* **修复方案**：
  * 在指令处理逻辑中，使用 `Pubkey::find_program_address` 重新计算 PDA。
  * 使用 `assert_eq!(pda_account.key, &expected_pda_key)` 强制校验。
* **设计哲学**：不需要在数据结构中显式存储 `owner` 字段。只要在逻辑上校验了“PDA 是由 User 公钥推导出来的” + “User 进行了签名”，就隐含了所有权验证。

### 2. 核心理论：区块链作为状态机

* **定义**：区块链本质上是一个状态机（State Machine）。交易是将状态 A 变为状态 B 的触发器。
* **UTXO 模型 (Bitcoin)**：
  * 交易验证的是“状态跳转路径的合法性”。
  * 比喻：输入是“蹲下”，输出是“离地2米”。链验证“能否从蹲下直接变到离地2米”。(验证路径)
* **账户模型 (Solana/Ethereum)**：
  * 交易包含“当前状态” + “具体动作 (Action/Instruction)”。
  * 比喻：状态是“蹲下”，动作是“起跳”。虚拟机执行动作后计算出新状态“离地2米”。(计算结果)

### 3. 实战项目：泰铢币 (Thai Zhu Coin) 开发

* **项目定位**：一个简单的 Layer 1 代币程序（非 SPL-Token，而是手动实现的精简版），用于理解代币背后的记账逻辑。

#### 3.1 数据结构设计

* **Account Data**：
  * 每个用户的 PDA 账户仅存储 **8字节** 数据。
  * 内容：`u64` (无符号64位整数)，以**大端序 (Big Endian)** 存储，代表代币余额。

#### 3.2指令数据 (Instruction Data) 设计

总长度：9 字节。

1. **Tag (1 byte)**：操作类型标识。
    * `0`: **Mint (铸造)**
    * `1`: **Transfer (转账)**
2. **Amount (8 bytes)**：涉及的金额。

#### 3.3 账户模型与权限

* **Mint 指令** (4个账户)：
    1. `Signer` (权限人，代码硬编码校验必须是 Ada 的公钥)。
    2. `PDA` (接收代币的账户)。
    3. `System Program` (用于创建账户)。
    4. `Rent` (用于计算租金)。
* **Transfer 指令** (6个账户)：
    1. `From Signer` (发送方，需签名 `is_signer: true`)。
    2. `From PDA` (发送方数据账户，需可写 `is_writable: true`)。
    3. `To PDA` (接收方数据账户，需可写 `is_writable: true`)。
    4. `To Wallet` (接收方钱包，用于推导/创建 PDA)。
    5. `System Program`。
    6. `Rent`。

#### 3.4 关键代码逻辑

1. **自动开户 (Auto-Initialization)**：
    * 在转账或铸造时，检查目标 PDA 数据是否为空（或账户不存在）。
    * 如果不存在，调用 `system_instruction::create_account` 自动创建，并支付 Rent。这对其用户体验非常重要。
2. **Mint 逻辑**：
    * 硬编码权限检查：`if mint_authority.key != &expected_pubkey { return Err(...) }`。
    * 读取旧余额 -> 加法 -> 写入新余额。
3. **Transfer 逻辑**：
    * **数值安全**：使用 Rust 的 `checked_sub` 和 `checked_add`。
        * 防止整数溢出（Overflow/Underflow）。例如余额 50 转 51，`checked_sub` 会返回 `None` 从而触发错误，避免变成巨量正数（黑客常用攻击手段）。
    * **原子性**：Solana 指令是原子的。减钱和加钱必须同时成功，否则整个交易回滚。

### 4. 关键技术问答 (Q&A Highlights)

* **Q: 为什么编译经常报错？**
  * **A**: `solana-program` 库依赖极其复杂，版本稍微不匹配就会报错。
  * **解决方案**: 推荐使用讲师提供的预配置好的 `Cargo.lock`。
  * **未来趋势**: 官方正在开发新库 **Pinocchio**，旨在替代 `solana-program`。它体积更小、Gas更低（部署费用低数倍）、性能更好。建议关注。

* **Q: 开发环境问题 (Python/Rust版本)**
  * 建议使用 Python 3.14 (Preview版本称为 Pi) 或兼容环境。
  * 客户端可以使用 TS (`web3.js`) 或 Rust 编写，非必须用 Python。
  * 本地测试链：使用 `solana-test-validator` 启动，默认会有带资金的测试账户。

* **Q: Solana 的并发模型 (Concurrent Transaction Execution)**
  * Solana 验证节点利用交易中声明的 `accounts` 进行调度。
  * 如果多笔交易涉及**同一个可写账户 (Writable Account)**，它们会被**串行**执行（锁机制）。
  * 如果交易涉及的账户互不重叠，它们会**并行**执行。
  * 转账 A->C 和 B->C，因为都涉及 C 的写权限，会被串行化，**不会出现并发竞态条件数据错乱**。

* **Q: 交易大小限制与解决方案**
  * Solana 交易基于 UDP 传输，受 MTU 限制，最大约 **1232 字节**。
  * 复杂交易（如 DeFi 涉及几十个账户）容易超限。
  * **解决方案**: **Address Lookup Table (ALT)** (2023年引入)。将账户地址列表预先存在链上，交易中只传 1 字节的索引 (Index)，极大节省空间。

* **Q: 手续费 (Gas Fees)**
  * **网络费**：固定每次签名 5000 Lamports。
  * **优先费 (Priority Fee)**：为了加速交易上链。目前很多 APP 默认设很高，其实设一点点（>0）就足够快了。
  * **租金 (Rent)**：存储数据需支付（可退还）。部署合约时费用较高（几 SOL），因为代码也是数据。Pinocchio 编译出的二进制更小，能省很多部署费。
