---
title: 第四次课课程笔记：互联网资本市场与代币开发实战
slug: solana-fourth-class
published: 2026-01-16
description: 深入探讨 Solana 作为互联网资本市场的愿景，以及从零构建泰铢币（Thai Zhu Coin）合约的实战开发笔记。
tags:
  - Solana
  - Rust
  - Smart Contract
  - DeFi
  - RWA
category: Web3
draft: false
---

> [!TIP]
> **课程概览**
>
> * **时间**: 2026年1月15日
> * **第一部分**: 互联网资本市场与 Solana 愿景 (主讲: Yao Yao - Solana Foundation)
> * **第二部分**: Solana 合约开发实战 - 代币程序 (主讲: 万彪)

---

## 第一部分：互联网资本市场与 Solana (Yao Yao)

### 1. 背景与愿景：互联网资本市场

* **传统金融体系的局限**：
  * **历史包袱**：现有运营模式已有百余年历史，基于原始的纸质/中心化账本逻辑。
  * **效率低下**：跨国转账、贸易结算周期长（T+n），无法满足现代全球化的高速需求。
* **互联网资本市场 (Internet Capital Market)**：
  * **定义**：基于区块链技术创建的、更加高效、普惠、全球化的新型资本市场。
  * **AI 与 Crypto 的结合**：
    * **趋势**：未来是 AI Agents 协助人类管理资产和生活的时代。
    * **协议适配**：AI 理解机器语言，而区块链提供了一套机器可理解的价值传输协议。
    * **愿景**：未来 Agents 之间作为链上独立节点，通过区块链协议（如 X 402 协议）直接完成转账结算。
  * **Solana 的角色**：不仅仅是“币圈”公链，更是**颠覆传统金融底层的互联网资本市场基础设施**。

### 2. 为什么是 Solana? (Layer 1 竞争力)

| 特性 | Layer 1 (Solana) | Layer 2 (Ethereum Ecosystem) |
| :--- | :--- | :--- |
| **流动性** | **全球统一**，所有资产在同一网络 | **分散/割裂**，分布在不同 L2，需跨链 |
| **互通性** | 无缝原子化组合 | 桥接复杂，资金效率低 |
| **性能** | 高并发，毫秒级确认 | L1 拥堵，L2 依赖 Sequencer |

* **Solana 的核心优势**：
  * **高性能与抗压能力**：久经沙场，即使在“特朗普发币”等极高并发事件中，网络依然稳定无宕机。
  * **真实价值支撑**：关注应用侧收入（Protocol Revenue），在非单纯融资故事的真实应用收入上断层领先。
  * **市场地位**：活跃用户全球最多，市值稳居前列。

### 3. 三大核心支柱与应用场景

互联网资本市场的三大核心用途：**支付结算 (Payments)**、**交易 (Trading)**、**融资 (Fundraising)**。

#### 3.1 稳定币与全球支付 (Payments)

* **传统痛点**：跨境贸易需线下填表、周期长（T+1/T+2）、费用高、资金托管在银行（Not your key, not your money）。
* **Solana 价值主张**：
  * **高效低成本**：底层性能支持高频、低忽略不计的 Gas 费。
  * **主要案例**：
    * **PayPal (PYUSD)**：利用 Solana 的 `Token Extensions` 实现合规功能（如冻结、白名单），流通量迅速攀升。
    * **Visa/Stripe**：Web2 巨头集成 Solana 进行后端结算。
    * **日常支付**：使用 Phantom 钱包几秒钟内完成跨境汇款。

#### 3.2 资产代币化与 RWA (Trading & Assets)

讲师提出了**资产图谱**的概念：

1. **有价格无价值**：如 **MEME Coins**。虽无实物支撑，但具备极高流动性和社区共识。
2. **有价值无价格**：如 **非标资产**（房地产债权、收藏卡牌）。
    * *案例*：Pokemon 卡牌开盲盒项目，将线下 RWA 映射到链上，通过概率机制赋予价格发现。
3. **既有价值又有价格**：理想资产，如 **美股、国债**。

**RWA (现实世界资产) 在 Solana 上的爆发**：

* **规模**：链上 RWA 总值超 10 亿美金。
* **机构入场**：**BlackRock**, **Franklin Templeton (Benji 应用)**, **Ondo**, **Apollo** 均在 Solana 发行产品。
* **美股代币化 (Xstock)**：
  * 允许在链上交易 NVDA, TSLA 等股票。
  * **普惠金融**：让欠发达地区用户也能投资美股。
  * **DeFi 乐高**：股票代币可作为抵押品放入 DeFi 协议（如 Byrio）赚取收益，实现 **"股息 + DeFi Yield"** 双重收益。

#### 3.3 链上融资 (Fundraising)

* **IPO 新范式**：
  * **Bullish**：传统美股 IPO 的同时，接受链上稳定币（11.5亿美金）注资。
  * **Pump.fun**：去中心化的“人人发币/一级市场”，无需投行券商。
* **Buildpad 案例**：
  * 链上的“打新”/分销平台，帮助项目募资通常能超募 3-5 倍。
  * **未来趋势**：股权与代币界限模糊，科技公司直接通过链上发行权益融资，绕过纳斯达克等传统路径。

---

## 第二部分：Solana 合约开发实战 - 代币程序 (万彪)

### 1. 课程回顾与安全漏洞修复

在上节课演示的“链上数据存储器”中，存在一个严重的安全隐患。

* **漏洞描述**：
    旧代码在处理 PDA (Program Derived Address) 时，虽然计算了 PDA，但**没有校验**传入的账户地址是否真正等于计算出的 PDA 地址。
  * *后果*：攻击者可以传入任意账户（如要把别人的数据写到自己的账户里，或者伪造身份）作为 `pda_account`。

* **修复代码 (Rust)**：

    ```rust
    // 1. 计算预期的 PDA
    let (expected_pda, _bump_seed) = Pubkey::find_program_address(
        &[b"my_seed", user_account.key.as_ref()], 
        program_id
    );

    // 2. 强制校验：传入的账户必须等于预期的 PDA
    assert_eq!(
        pda_account.key, 
        &expected_pda, 
        "PDA account mismatch!"
    );
    ```

* **设计哲学**：Solana 程序中不需要显式存储 `owner` 字段。只要校验了 **"PDA 是由 User 公钥推导出来的"** + **"User 对交易进行了签名"**，就数学上隐含了所有权验证。

### 2. 核心理论：区块链作为状态机

* **UTXO 模型 (Bitcoin)**：
  * 验证的是**路径合法性**。
  * *比喻*：输入“蹲下”，输出“离地2米”。链验证“能否从蹲下直接变到离地2米”。
* **账户模型 (Solana/Ethereum)**：
  * 验证的是**计算结果**。
  * *比喻*：状态是“蹲下”，动作是“起跳”。虚拟机执行动作后，更新状态为“离地2米”。

### 3. 实战项目：泰铢币 (Thai Zhu Coin)

**项目定位**：一个从零手写的 Layer 1 代币程序（非标准 SPL-Token），用于深入理解代币背后的账本逻辑（Mint & Transfer）。

#### 3.1 数据结构设计

**账户数据 (Account Data)**
每个用户的 PDA 账户仅存储 8 字节的余额数据。

```rust
// 存储格式：Big Endian u64
pub struct ThaiZhuAccount {
    pub balance: u64, 
}
```

**指令数据 (Instruction Data)**
总长度：9 字节。

| Offset | Field | Type | Description |
| :--- | :--- | :--- | :--- |
| `0` | **Tag** | `u8` | `0` = Mint, `1` = Transfer |
| `1..9` | **Amount** | `u64` | Big Endian 格式的金额 |

#### 3.2 账户模型与权限 (Account Inputs)

Solana 的指令执行需要显式传入所有涉及的账户。

**1. Mint 指令 (铸造)**

| Index | Account | is_signer | is_writable | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| 0 | `Mint Authority` | ✅ | ❌ | 必须是硬编码的管理员 (Ada) |
| 1 | `Token Account` | ❌ | ✅ | 接收代币的 PDA |
| 2 | `System Program` | ❌ | ❌ | 用于新建账户 |
| 3 | `Rent Sysvar` | ❌ | ❌ | 用于检查租金豁免 |

**2. Transfer 指令 (转账)**

| Index | Account | is_signer | is_writable | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| 0 | `From Signer` | ✅ | ✅ | 发送方钱包 (付 Gas/做主) |
| 1 | `From PDA` | ❌ | ✅ | 发送方余额账户 |
| 2 | `To PDA` | ❌ | ✅ | 接收方余额账户 |
| 3 | `To Wallet` | ❌ | ❌ | 接收方钱包 (推导 PDA 用) |
| 4 | `System Program` | ❌ | ❌ | 若 To PDA 不存在则创建 |
| 5 | `Rent Sysvar` | ❌ | ❌ | |

#### 3.3 关键逻辑实现

1. **自动开户 (Auto-Initialization)**：
    * **体验优化**：在转账时，如果检测到接收方 PDA 数据为空（`data_is_empty`）或账户未初始化，程序会自动调用 `system_instruction::create_account` 创建账户并由发送方支付租金。
    * 这避免了用户必须先“注册”才能“收款”的繁琐步骤。

2. **数值安全 (Safe Math)**：
    * 使用 Rust 的 `checked_sub` 和 `checked_add` 防止溢出。

    ```rust
    // ❌ 错误示范：产生溢出风险
    // from.balance -= amount; 
    
    // ✅ 正确示范
    from.balance = from.balance.checked_sub(amount).ok_or(ProgramError::InsufficientFunds)?;
    to.balance = to.balance.checked_add(amount).ok_or(ProgramError::Overflow)?;
    ```

    * **原子性**：Solana 指令执行是原子的。如果 `checked_add` 失败，前面的 `checked_sub` 也会回滚。

### 4. 关键技术问答 (Q&A Highlights)

> [!NOTE]
> **Q: 为什么编译经常报错？**
>
> * **原因**：`solana-program` 库依赖树复杂，版本不匹配是常见问题。
> * **趋势**：官方正在开发新库 **Pinocchio**，旨在替代 `solana-program`。
>   * 优势：体积更小、Gas 更低（部署费省数倍）、编译更快。
>   * 建议：保持关注，未来迁移。

> [!NOTE]
> **Q: 交易大小限制与解决方案？**
>
> * **限制**：基于 UDP 传输 (QUIC)，MTU 限制导致交易最大约 **1232 字节**。
> * **问题**：DeFi 组合操作往往涉及几十个账户，公钥 (32 bytes) 太多不仅占空间，还容易超限。
> * **解法**：**Address Lookup Table (ALT / v0 Transactions)**。
>   * 将常用地址列表存上链，交易中只传 1 字节的 `Index` (索引) 引用它们，极大节省空间。

> [!NOTE]
> **Q: Solana 如何处理并发 (Concurrency)？**
>
> * **Sealevel 运行时**：
>   * 验证节点根据交易声明的 `accounts` 进行调度。
>   * **串行**：多笔交易涉及**同一个可写账户 (Writable)** 时，必须排队（锁机制）。
>   * **并行**：交易涉及的账户互不重叠时，并行执行，吞吐量极大。
> * **结论**：转账 A->C 和 B->C 都会修改 C 的余额，因此会被串行化，**不会出现竞态条件 (Race Condition)**。
